(function($){$.TileDrag=function(element,options){var defaults ={};var plugin=this;plugin.settings ={};var $element=$(element),$startMenu,$groups,settings,tiles,$draggingTile,$parentGroup,draggingTileWidth,draggingTileHeight,$phantomTile,tileDeltaX,tileDeltaY,tilesCoordinates,tileSearchCount=0,tileUnderCursorIndex,tileUnderCursorSide,newGroupsCoordinates,newGroupSearchCount=0,newGroupPhantom,targetType,groupsMaxHeight,mouseMoved,tileDragTimer;plugin.init=function(){settings=plugin.settings=$.extend({},defaults,options);$startMenu=$('.tiles');$groups=$('[data-role=tile-group],.tile-group');tiles=$groups.children('.tile');tiles.on('mousedown',startDrag);};var startDrag=function(event){var $tile,tilePosition,tilePositionX,tilePositionY;event.preventDefault();$tile=$draggingTile=$(this);draggingTileWidth=$tile.outerWidth();draggingTileHeight=$tile.outerHeight();$phantomTile=$('<div></div>');$phantomTile.css({'background':'none'});$phantomTile.addClass('tile');if ($tile.hasClass('double')){$phantomTile.addClass('double');}else if ($tile.hasClass('triple')){$phantomTile.addClass('triple');}else if ($tile.hasClass('quadro')){$phantomTile.addClass('quadro');}if ($tile.hasClass('double-vertical')){$phantomTile.addClass('double-vertical');}else if ($tile.hasClass('triple-vertical')){$phantomTile.addClass('triple-vertical');}else if ($tile.hasClass('quadro-vertical')){$phantomTile.addClass('quadro-vertical');}$phantomTile.insertAfter($tile);targetType='existing';$parentGroup=$tile.parents('.tile-group');tilePosition=$tile.offset();tilePositionX=tilePosition.left-(event.pageX-event.clientX);tilePositionY=tilePosition.top-(event.pageY-event.clientY);tileDeltaX=event.clientX-tilePositionX;tileDeltaY=event.clientY-tilePositionY;$tile.detach();$tile.insertAfter($($groups.get(-1)));$tile.css({'position':'fixed','left':tilePositionX,'top':tilePositionY,'z-index':100000});$tile.data('dragging',true);storeTilesCoordinates();storeNewGroupsCoordinates();$(document).on('mousemove.tiledrag',dragTile);$(document).one('mouseup.tiledrag',dragStop);mouseMoved=false;$groups.trigger('drag',[$draggingTile,$parentGroup]);};var dragTile=function (event){mouseMoved=true;event.preventDefault();$draggingTile.css({'left':event.clientX-tileDeltaX,'top':event.clientY-tileDeltaY});clearTimeout(tileDragTimer);tileDragTimer=setTimeout(function(){findPlace(event);},50);};var findPlace=function (event){var findTileIndex,findNewGroup;findTileIndex=findTileUnderCursor(event);if (findTileIndex){clearPlaceForTile($(tiles[findTileIndex]));}else{findNewGroup=findNewGroupUnderCursor(event);if (findNewGroup){showNewGroupPhantom(findNewGroup.group,findNewGroup.side);}}};var dragStop=function (event){var targetGroup;if (!mouseMoved){if ($draggingTile.is('a')){if ($draggingTile.prop('target') === '_blank'){window.open($draggingTile.attr('href'));}else{window.location.href=$draggingTile.attr('href');}}}else{event.preventDefault();}clearTimeout(tileDragTimer);findPlace(event);$draggingTile.detach();if (targetType === 'existing'){$draggingTile.insertAfter($phantomTile);targetGroup=$phantomTile.parents('.tile-group');$phantomTile.remove();}else{newGroupPhantom.css({'backgroundColor':'','width':'auto','max-width':'322px','height':''});$draggingTile.appendTo(newGroupPhantom);targetGroup=newGroupPhantom;newGroupPhantom=undefined;}if ($parentGroup.find('.tile').length === 0){$parentGroup.remove();}$draggingTile.css({'position':'','left':'','top':'','z-index':''});$draggingTile.data('dragging',false);$(document).off('mousemove.tiledrag');$groups=$('[data-role=tile-group],.tile-group');$groups.trigger('drop',[$draggingTile,targetGroup]);$startMenu.trigger('changed');};var storeTilesCoordinates=function (){tilesCoordinates ={};tiles.each(function (index,tile){var $tile,offset;$tile=$(tile);if ($tile.data('dragging')) return;offset=$tile.offset();tilesCoordinates[index] ={x1:offset.left+tileDeltaX-draggingTileWidth/2,y1:offset.top+tileDeltaY-draggingTileHeight/2,x2:offset.left+$tile.outerWidth()+tileDeltaX-draggingTileWidth/2,y2:offset.top+$tile.outerHeight()+tileDeltaY-draggingTileHeight/2}});};var storeNewGroupsCoordinates=function (){groupsMaxHeight=0;newGroupsCoordinates=[];$groups.each(function(index){var offset,width,height,$group;$group=$(this);offset=$group.offset();width=$group.width();height=$group.height();if (index === 0){newGroupsCoordinates.push({x1:offset.left-70+tileDeltaX-draggingTileWidth/2,x2:offset.left+tileDeltaX-draggingTileWidth/2,y1:offset.top+tileDeltaY-draggingTileHeight/2,y2:offset.top+height+tileDeltaY-draggingTileHeight/2,side:'before',group:$group});}newGroupsCoordinates.push({x1:offset.left+width+tileDeltaX-draggingTileWidth/2,x2:offset.left+width+70+tileDeltaX-draggingTileWidth/2,y1:offset.top+tileDeltaY-draggingTileHeight/2,y2:offset.top+height+tileDeltaY-draggingTileHeight/2,side:'after',group:$group});if (groupsMaxHeight<height){groupsMaxHeight=height;}});};var findTileUnderCursor=function (event){var i,coord,tileIndex=false,tileSide;for (i in tilesCoordinates){if (!tilesCoordinates.hasOwnProperty(i)) return;coord=tilesCoordinates[i];if (coord.x1<event.pageX&&event.pageX<coord.x2&&coord.y1<event.pageY&&event.pageY<coord.y2){tileIndex=i;break;}}if (tileIndex){if (event.pageX<coord.x1+$(tiles[tileIndex]).outerWidth()/2){tileSide='before';}else{tileSide='after';}}if (tileSide === tileUnderCursorSide&&tileIndex === tileUnderCursorIndex){return false;}tileUnderCursorSide=tileSide;tileUnderCursorIndex=tileIndex;return tileIndex;};var findNewGroupUnderCursor=function (event){var i,coord,newGroup=false;for (i in newGroupsCoordinates){if (!newGroupsCoordinates.hasOwnProperty(i)) return;coord=newGroupsCoordinates[i];if (coord.x1<event.pageX&&event.pageX<coord.x2&&coord.y1<event.pageY&&event.pageY<coord.y2){newGroup=coord;break;}}if (!newGroup){return false;}else{return newGroup;}};var clearPlaceForTile=function ($tileUnderCursor){var $oldPhantomTile,$newParentGroup;$oldPhantomTile=$phantomTile;$phantomTile=$oldPhantomTile.clone();targetType='existing';if (tileUnderCursorSide === 'before'){$phantomTile.insertBefore($tileUnderCursor);}else{$phantomTile.insertAfter($tileUnderCursor);}if (newGroupPhantom){newGroupPhantom.remove();}$oldPhantomTile.remove();if ($parentGroup.find('.tile').length === 0){$newParentGroup=$tileUnderCursor.parent('.tile-group');if ($parentGroup[0] !== $newParentGroup[0]){$parentGroup.css({'width':0,'margin':0});}}$startMenu.trigger('changed');storeAllNecessaryCoordinates();};var showNewGroupPhantom=function (relGroup,side){if ($phantomTile){$phantomTile.remove()}if (newGroupPhantom){newGroupPhantom.remove();}newGroupPhantom=$('<div class="tile-group"></div>');newGroupPhantom.css({'height':groupsMaxHeight,'width':'70px','backgroundColor':'#333333','position':'relative'});relGroup[side](newGroupPhantom);targetType='new';if ($parentGroup.find('.tile').length === 0){$parentGroup.css({'width':0,'margin':0});}$startMenu.trigger('changed');storeAllNecessaryCoordinates();};var storeAllNecessaryCoordinates=function (){storeTilesCoordinates();storeNewGroupsCoordinates();};plugin.getGroups=function (){return $groups;};plugin.init();};$.fn.TileDrag=function(options){var group=$(this[0]);if (undefined == group.data('TileDrag')){var plugin=new $.TileDrag(group,options);var $groups=plugin.getGroups();$groups.data('TileDrag',plugin);}};})(jQuery);$(function(){var allTileGroups=$('[data-role=tile-group],.tile-group');if (allTileGroups.length>0){$(allTileGroups).TileDrag({});}});